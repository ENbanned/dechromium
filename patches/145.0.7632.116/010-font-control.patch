From d1a8442d6614878284babdabdb0a00d682aad780 Mon Sep 17 00:00:00 2001
From: ENbanned <nik.skvortsov2007@gmail.com>
Date: Fri, 27 Feb 2026 21:19:57 +0000
Subject: [PATCH 10/10] 010-font-control

Strict font family matching in font_cache_skia.cc:
- Return nullptr when requested font name doesn't match actual family name
- Prevents font fallback fingerprinting
- Generic families (serif, sans-serif, monospace, etc.) are exempted
---
 .../platform/fonts/skia/font_cache_skia.cc    | 25 ++++++++++++++++++-
 1 file changed, 24 insertions(+), 1 deletion(-)

diff --git a/third_party/blink/renderer/platform/fonts/skia/font_cache_skia.cc b/third_party/blink/renderer/platform/fonts/skia/font_cache_skia.cc
index e8f0e57b0391b..50dcec7c4e0da 100644
--- a/third_party/blink/renderer/platform/fonts/skia/font_cache_skia.cc
+++ b/third_party/blink/renderer/platform/fonts/skia/font_cache_skia.cc
@@ -36,6 +36,7 @@
 #include "base/check_op.h"
 #include "base/metrics/histogram_functions.h"
 #include "base/notreached.h"
+#include "base/strings/string_util.h"
 #include "base/strings/string_view_util.h"
 #include "build/build_config.h"
 #include "skia/ext/font_utils.h"
@@ -292,8 +293,30 @@ sk_sp<SkTypeface> FontCache::CreateTypeface(
       return typeface;
   }
 #endif  // BUILDFLAG(IS_ANDROID)
-  return sk_sp<SkTypeface>(skia::DefaultFontMgr()->matchFamilyStyle(
+  sk_sp<SkTypeface> typeface(skia::DefaultFontMgr()->matchFamilyStyle(
       name.empty() ? nullptr : name.c_str(), font_description.SkiaFontStyle()));
+  if (typeface && !name.empty()) {
+    static constexpr const char* kGenericFamilies[] = {
+        "serif",      "sans-serif",    "monospace",    "cursive",
+        "fantasy",    "system-ui",     "ui-serif",     "ui-sans-serif",
+        "ui-monospace", "ui-rounded",  "math",         "emoji",
+    };
+    bool is_generic = false;
+    for (const char* g : kGenericFamilies) {
+      if (base::EqualsCaseInsensitiveASCII(name, g)) {
+        is_generic = true;
+        break;
+      }
+    }
+    if (!is_generic) {
+      SkString actual_family;
+      typeface->getFamilyName(&actual_family);
+      if (!base::EqualsCaseInsensitiveASCII(name, actual_family.c_str())) {
+        return nullptr;
+      }
+    }
+  }
+  return typeface;
 }
 
 #if !BUILDFLAG(IS_WIN)
-- 
2.39.5

