From 313001e41dfef02824655ffd02e8ad4f1c8d0881 Mon Sep 17 00:00:00 2001
From: ENbanned <nik.skvortsov2007@gmail.com>
Date: Fri, 27 Feb 2026 21:19:31 +0000
Subject: [PATCH 06/10] 006-webgl-fingerprint

Expanded WebGL fingerprint spoofing:
- getParameter: 22 hardware params via --aspect-webgl-params (key=value CSV)
- getParameter: vendor/renderer strings via --aspect-webgl-vendor/renderer
- getSupportedExtensions: filter to allowed list via --aspect-webgl-extensions
- getShaderPrecisionFormat: override HIGH/MEDIUM precision via
  --aspect-webgl-precision-high/medium (rangeMin,rangeMax,precision)
---
 .../webgl/webgl_rendering_context_base.cc     | 163 ++++++++++++++++++
 1 file changed, 163 insertions(+)

diff --git a/third_party/blink/renderer/modules/webgl/webgl_rendering_context_base.cc b/third_party/blink/renderer/modules/webgl/webgl_rendering_context_base.cc
index 72a80ba576711..0f89b382dbe02 100644
--- a/third_party/blink/renderer/modules/webgl/webgl_rendering_context_base.cc
+++ b/third_party/blink/renderer/modules/webgl/webgl_rendering_context_base.cc
@@ -110,6 +110,11 @@
 #include "third_party/blink/renderer/modules/webgl/webgl_context_attribute_helpers.h"
 #include "third_party/blink/renderer/modules/webgl/webgl_context_event.h"
 #include "third_party/blink/renderer/modules/webgl/webgl_debug_renderer_info.h"
+#include "base/command_line.h"
+#include "base/no_destructor.h"
+#include "base/strings/string_number_conversions.h"
+#include "base/strings/string_split.h"
+#include "third_party/blink/public/common/switches.h"
 #include "third_party/blink/renderer/modules/webgl/webgl_debug_shaders.h"
 #include "third_party/blink/renderer/modules/webgl/webgl_depth_texture.h"
 #include "third_party/blink/renderer/modules/webgl/webgl_draw_buffers.h"
@@ -188,6 +193,20 @@ unsigned WebGLRenderingContextBase::max_active_webgl_contexts_on_worker_ = 0;
 
 namespace {
 
+// Aspect: parse comma-separated "key=value" param string.
+// Format: "MAX_TEXTURE_SIZE=4096,MAX_RENDERBUFFER_SIZE=4096,..."
+// Returns the value for |key|, or empty string if not found.
+std::string AspectGetWebglParam(const std::string& params,
+                                const std::string& key) {
+  for (const auto& pair : base::SplitStringPiece(
+           params, ",", base::TRIM_WHITESPACE, base::SPLIT_WANT_NONEMPTY)) {
+    size_t eq = pair.find('=');
+    if (eq != std::string_view::npos && pair.substr(0, eq) == key)
+      return std::string(pair.substr(eq + 1));
+  }
+  return {};
+}
+
 enum class WebGLANGLEImplementation {
   // These values are persisted to logs. Entries should not be renumbered and
   // numeric values should never be reused.
@@ -3767,6 +3786,83 @@ ScriptValue WebGLRenderingContextBase::getParameter(ScriptState* script_state,
                                                     GLenum pname) {
   if (isContextLost())
     return ScriptValue::CreateNull(script_state->GetIsolate());
+
+  // Aspect: intercept hardware-dependent params with spoofed values.
+  {
+    static const base::NoDestructor<std::string> webgl_params([]() -> std::string {
+      const auto& cmd = *base::CommandLine::ForCurrentProcess();
+      if (cmd.HasSwitch(blink::switches::kAspectWebglParams))
+        return cmd.GetSwitchValueASCII(blink::switches::kAspectWebglParams);
+      return {};
+    }());
+    if (!webgl_params->empty()) {
+      // Map GL enum to param key name.
+      const char* param_key = nullptr;
+      bool is_int_param = true;
+      switch (pname) {
+        case GL_MAX_TEXTURE_SIZE: param_key = "MAX_TEXTURE_SIZE"; break;
+        case GL_MAX_CUBE_MAP_TEXTURE_SIZE: param_key = "MAX_CUBE_MAP_TEXTURE_SIZE"; break;
+        case GL_MAX_RENDERBUFFER_SIZE: param_key = "MAX_RENDERBUFFER_SIZE"; break;
+        case GL_MAX_VIEWPORT_DIMS: param_key = "MAX_VIEWPORT_DIMS"; break;
+        case GL_MAX_TEXTURE_IMAGE_UNITS: param_key = "MAX_TEXTURE_IMAGE_UNITS"; break;
+        case GL_MAX_COMBINED_TEXTURE_IMAGE_UNITS: param_key = "MAX_COMBINED_TEXTURE_IMAGE_UNITS"; break;
+        case GL_MAX_VERTEX_ATTRIBS: param_key = "MAX_VERTEX_ATTRIBS"; break;
+        case GL_MAX_VERTEX_TEXTURE_IMAGE_UNITS: param_key = "MAX_VERTEX_TEXTURE_IMAGE_UNITS"; break;
+        case GL_MAX_VERTEX_UNIFORM_VECTORS: param_key = "MAX_VERTEX_UNIFORM_VECTORS"; break;
+        case GL_MAX_FRAGMENT_UNIFORM_VECTORS: param_key = "MAX_FRAGMENT_UNIFORM_VECTORS"; break;
+        case GL_MAX_VARYING_VECTORS: param_key = "MAX_VARYING_VECTORS"; break;
+        case GL_ALIASED_LINE_WIDTH_RANGE:
+          param_key = "ALIASED_LINE_WIDTH_RANGE"; is_int_param = false; break;
+        case GL_ALIASED_POINT_SIZE_RANGE:
+          param_key = "ALIASED_POINT_SIZE_RANGE"; is_int_param = false; break;
+        case GL_SUBPIXEL_BITS: param_key = "SUBPIXEL_BITS"; break;
+        case GL_RED_BITS: param_key = "RED_BITS"; break;
+        case GL_GREEN_BITS: param_key = "GREEN_BITS"; break;
+        case GL_BLUE_BITS: param_key = "BLUE_BITS"; break;
+        case GL_ALPHA_BITS: param_key = "ALPHA_BITS"; break;
+        case GL_DEPTH_BITS: param_key = "DEPTH_BITS"; break;
+        case GL_STENCIL_BITS: param_key = "STENCIL_BITS"; break;
+        case GL_SAMPLE_BUFFERS: param_key = "SAMPLE_BUFFERS"; break;
+        case GL_SAMPLES: param_key = "SAMPLES"; break;
+        default: break;
+      }
+      if (param_key) {
+        std::string val_str = AspectGetWebglParam(*webgl_params, param_key);
+        if (!val_str.empty()) {
+          if (pname == GL_MAX_VIEWPORT_DIMS) {
+            // "WxH" format, e.g. "16384x16384"
+            size_t x_pos = val_str.find('x');
+            if (x_pos != std::string::npos) {
+              int w = 0, h = 0;
+              base::StringToInt(val_str.substr(0, x_pos), &w);
+              base::StringToInt(val_str.substr(x_pos + 1), &h);
+              GLint dims[2] = {w, h};
+              return WebGLAny(script_state,
+                  DOMInt32Array::Create(base::span(dims)));
+            }
+          } else if (pname == GL_ALIASED_LINE_WIDTH_RANGE ||
+                     pname == GL_ALIASED_POINT_SIZE_RANGE) {
+            // "min-max" format, e.g. "1-1" or "1-1024"
+            size_t dash = val_str.find('-');
+            if (dash != std::string::npos) {
+              double lo = 0, hi = 0;
+              base::StringToDouble(val_str.substr(0, dash), &lo);
+              base::StringToDouble(val_str.substr(dash + 1), &hi);
+              GLfloat range[2] = {static_cast<GLfloat>(lo),
+                                  static_cast<GLfloat>(hi)};
+              return WebGLAny(script_state,
+                  DOMFloat32Array::Create(base::span(range)));
+            }
+          } else if (is_int_param) {
+            int v = 0;
+            if (base::StringToInt(val_str, &v))
+              return WebGLAny(script_state, v);
+          }
+        }
+      }
+    }
+  }
+
   const int kIntZero = 0;
   switch (pname) {
     case GL_ACTIVE_TEXTURE:
@@ -3976,6 +4072,12 @@ ScriptValue WebGLRenderingContextBase::getParameter(ScriptState* script_state,
       return ScriptValue::CreateNull(script_state->GetIsolate());
     case WebGLDebugRendererInfo::kUnmaskedRendererWebgl:
       if (ExtensionEnabled(kWebGLDebugRendererInfoName)) {
+        {
+          const auto& cmd = *base::CommandLine::ForCurrentProcess();
+          if (cmd.HasSwitch(blink::switches::kAspectWebglRenderer))
+            return WebGLAny(script_state, String(cmd.GetSwitchValueASCII(
+                blink::switches::kAspectWebglRenderer)));
+        }
         return WebGLAny(script_state,
                         String(ContextGL()->GetString(GL_RENDERER)));
       }
@@ -3985,6 +4087,12 @@ ScriptValue WebGLRenderingContextBase::getParameter(ScriptState* script_state,
       return ScriptValue::CreateNull(script_state->GetIsolate());
     case WebGLDebugRendererInfo::kUnmaskedVendorWebgl:
       if (ExtensionEnabled(kWebGLDebugRendererInfoName)) {
+        {
+          const auto& cmd = *base::CommandLine::ForCurrentProcess();
+          if (cmd.HasSwitch(blink::switches::kAspectWebglVendor))
+            return WebGLAny(script_state, String(cmd.GetSwitchValueASCII(
+                blink::switches::kAspectWebglVendor)));
+        }
         return WebGLAny(script_state,
                         String(ContextGL()->GetString(GL_VENDOR)));
       }
@@ -4286,6 +4394,35 @@ WebGLShaderPrecisionFormat* WebGLRenderingContextBase::getShaderPrecisionFormat(
   GLint precision = 0;
   ContextGL()->GetShaderPrecisionFormat(shader_type, precision_type, range,
                                         &precision);
+
+  // Aspect: override shader precision for HIGH_FLOAT/HIGH_INT and MEDIUM_FLOAT/MEDIUM_INT.
+  // Format: "rangeMin,rangeMax,precision" e.g. "127,127,23"
+  {
+    const auto& cmd = *base::CommandLine::ForCurrentProcess();
+    const char* switch_name = nullptr;
+    if ((precision_type == GL_HIGH_FLOAT || precision_type == GL_HIGH_INT) &&
+        cmd.HasSwitch(blink::switches::kAspectWebglPrecisionHigh))
+      switch_name = blink::switches::kAspectWebglPrecisionHigh;
+    else if ((precision_type == GL_MEDIUM_FLOAT || precision_type == GL_MEDIUM_INT) &&
+             cmd.HasSwitch(blink::switches::kAspectWebglPrecisionMedium))
+      switch_name = blink::switches::kAspectWebglPrecisionMedium;
+    if (switch_name) {
+      std::string switch_val = cmd.GetSwitchValueASCII(switch_name);
+      auto parts = base::SplitStringPiece(
+          switch_val, ",",
+          base::TRIM_WHITESPACE, base::SPLIT_WANT_NONEMPTY);
+      if (parts.size() == 3) {
+        int r0 = 0, r1 = 0, p = 0;
+        base::StringToInt(parts[0], &r0);
+        base::StringToInt(parts[1], &r1);
+        base::StringToInt(parts[2], &p);
+        range[0] = r0;
+        range[1] = r1;
+        precision = p;
+      }
+    }
+  }
+
   return MakeGarbageCollected<WebGLShaderPrecisionFormat>(range[0], range[1],
                                                           precision);
 }
@@ -4309,6 +4446,32 @@ WebGLRenderingContextBase::getSupportedExtensions() {
     }
   }
 
+  // Aspect: filter extensions list via --aspect-webgl-extensions.
+  // Format: comma-separated list of extension names to KEEP.
+  // If the switch is present, only listed extensions are returned.
+  {
+    static const base::NoDestructor<std::string> ext_filter([]() -> std::string {
+      const auto& cmd = *base::CommandLine::ForCurrentProcess();
+      if (cmd.HasSwitch(blink::switches::kAspectWebglExtensions))
+        return cmd.GetSwitchValueASCII(blink::switches::kAspectWebglExtensions);
+      return {};
+    }());
+    if (!ext_filter->empty()) {
+      auto allowed = base::SplitStringPiece(
+          *ext_filter, ",", base::TRIM_WHITESPACE, base::SPLIT_WANT_NONEMPTY);
+      Vector<String> filtered;
+      for (const auto& ext : result) {
+        for (const auto& a : allowed) {
+          if (ext == String(a)) {
+            filtered.push_back(ext);
+            break;
+          }
+        }
+      }
+      return filtered;
+    }
+  }
+
   return result;
 }
 
-- 
2.39.5

