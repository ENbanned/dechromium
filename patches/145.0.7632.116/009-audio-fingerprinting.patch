From 59d6c7c3af6b9d0e11bc633cfd3c9a9a3cc521d4 Mon Sep 17 00:00:00 2001
From: ENbanned <nik.skvortsov2007@gmail.com>
Date: Thu, 26 Feb 2026 11:28:03 +0000
Subject: [PATCH 09/11] 009-audio-fingerprinting

---
 .../renderer_host/render_process_host_impl.cc |  1 +
 third_party/blink/common/switches.cc          |  1 +
 third_party/blink/public/common/switches.h    |  1 +
 .../renderer/modules/webaudio/audio_buffer.cc | 36 +++++++++++
 .../renderer/modules/webaudio/audio_buffer.h  |  4 ++
 .../modules/webaudio/realtime_analyser.cc     | 62 +++++++++++++++++++
 6 files changed, 105 insertions(+)

diff --git a/content/browser/renderer_host/render_process_host_impl.cc b/content/browser/renderer_host/render_process_host_impl.cc
index eb6e7fbb13bd0..e4b6c8a9cc597 100644
--- a/content/browser/renderer_host/render_process_host_impl.cc
+++ b/content/browser/renderer_host/render_process_host_impl.cc
@@ -3806,6 +3806,7 @@ void RenderProcessHostImpl::PropagateBrowserCommandLineToRenderer(
       blink::switches::kAspectCanvasNoiseSeed,
       blink::switches::kAspectWebglVendor,
       blink::switches::kAspectWebglRenderer,
+      blink::switches::kAspectAudioNoiseSeed,
       // Please keep these in alphabetical order. Compositor switches here
       // should also be added to
       // chrome/browser/ash/login/chrome_restart_request.cc.
diff --git a/third_party/blink/common/switches.cc b/third_party/blink/common/switches.cc
index 6fe14b04410bd..af4c9dee8105b 100644
--- a/third_party/blink/common/switches.cc
+++ b/third_party/blink/common/switches.cc
@@ -175,6 +175,7 @@ const char kAspectUaArch[] = "aspect-ua-arch";
 const char kAspectCanvasNoiseSeed[] = "aspect-canvas-noise-seed";
 const char kAspectWebglVendor[] = "aspect-webgl-vendor";
 const char kAspectWebglRenderer[] = "aspect-webgl-renderer";
+const char kAspectAudioNoiseSeed[] = "aspect-audio-noise-seed";
 
 }  // namespace switches
 }  // namespace blink
diff --git a/third_party/blink/public/common/switches.h b/third_party/blink/public/common/switches.h
index 3cf962472366b..5c4ed1c57df54 100644
--- a/third_party/blink/public/common/switches.h
+++ b/third_party/blink/public/common/switches.h
@@ -71,6 +71,7 @@ BLINK_COMMON_EXPORT extern const char kAspectUaArch[];
 BLINK_COMMON_EXPORT extern const char kAspectCanvasNoiseSeed[];
 BLINK_COMMON_EXPORT extern const char kAspectWebglVendor[];
 BLINK_COMMON_EXPORT extern const char kAspectWebglRenderer[];
+BLINK_COMMON_EXPORT extern const char kAspectAudioNoiseSeed[];
 }  // namespace switches
 }  // namespace blink
 
diff --git a/third_party/blink/renderer/modules/webaudio/audio_buffer.cc b/third_party/blink/renderer/modules/webaudio/audio_buffer.cc
index 40a355dec4aad..c73072bcedea0 100644
--- a/third_party/blink/renderer/modules/webaudio/audio_buffer.cc
+++ b/third_party/blink/renderer/modules/webaudio/audio_buffer.cc
@@ -39,6 +39,9 @@
 #include "third_party/blink/renderer/platform/bindings/exception_messages.h"
 #include "third_party/blink/renderer/platform/bindings/exception_state.h"
 #include "third_party/blink/renderer/platform/wtf/text/strcat.h"
+#include <random>
+#include "base/command_line.h"
+#include "third_party/blink/public/common/switches.h"
 
 namespace blink {
 
@@ -212,6 +215,7 @@ NotShared<DOMFloat32Array> AudioBuffer::getChannelData(
     return NotShared<DOMFloat32Array>(nullptr);
   }
 
+  MaybeApplyAudioNoise();
   return getChannelData(channel_index);
 }
 
@@ -250,6 +254,7 @@ void AudioBuffer::copyFromChannel(NotShared<DOMFloat32Array> destination,
     return;
   }
 
+  MaybeApplyAudioNoise();
   base::span<const float> src = channels_[channel_number].Get()->AsSpan();
   base::span<float> dst = destination->AsSpan();
 
@@ -325,6 +330,37 @@ std::unique_ptr<SharedAudioBuffer> AudioBuffer::CreateSharedAudioBuffer() {
   return std::make_unique<SharedAudioBuffer>(this);
 }
 
+void AudioBuffer::MaybeApplyAudioNoise() {
+  if (audio_noise_applied_) {
+    return;
+  }
+  audio_noise_applied_ = true;
+
+  auto* cmd = base::CommandLine::ForCurrentProcess();
+  if (!cmd->HasSwitch(blink::switches::kAspectAudioNoiseSeed)) {
+    return;
+  }
+
+  uint64_t base_seed = 0;
+  auto seed_str = cmd->GetSwitchValueASCII(blink::switches::kAspectAudioNoiseSeed);
+  for (char c : seed_str) {
+    base_seed = base_seed * 31 + static_cast<uint64_t>(c);
+  }
+
+  uint64_t buffer_seed = base_seed ^ (static_cast<uint64_t>(length_) * 2654435761u)
+                                    ^ (static_cast<uint64_t>(channels_.size()) * 40503u);
+  std::mt19937_64 rng(buffer_seed);
+
+  for (unsigned ch = 0; ch < channels_.size(); ++ch) {
+    base::span<float> data = channels_[ch].Get()->AsSpan();
+    for (size_t i = 0; i < data.size(); ++i) {
+      float noise = static_cast<float>(
+          static_cast<int64_t>(rng() % 2001) - 1000) * 1e-7f;
+      data[i] += noise;
+    }
+  }
+}
+
 SharedAudioBuffer::SharedAudioBuffer(AudioBuffer* buffer)
     : sample_rate_(buffer->sampleRate()), length_(buffer->length()) {
   channels_.resize(buffer->numberOfChannels());
diff --git a/third_party/blink/renderer/modules/webaudio/audio_buffer.h b/third_party/blink/renderer/modules/webaudio/audio_buffer.h
index 2e798e3e5bae7..64d9f52817c83 100644
--- a/third_party/blink/renderer/modules/webaudio/audio_buffer.h
+++ b/third_party/blink/renderer/modules/webaudio/audio_buffer.h
@@ -36,6 +36,7 @@
 #include "third_party/blink/renderer/platform/heap/collection_support/heap_vector.h"
 #include "third_party/blink/renderer/platform/wtf/allocator/allocator.h"
 #include "third_party/blink/renderer/platform/wtf/vector.h"
+#include <random>
 
 namespace blink {
 
@@ -116,6 +117,9 @@ class MODULES_EXPORT AudioBuffer final : public ScriptWrappable {
   std::unique_ptr<SharedAudioBuffer> CreateSharedAudioBuffer();
 
  private:
+void MaybeApplyAudioNoise();
+  bool audio_noise_applied_ = false;
+
   static DOMFloat32Array* CreateFloat32ArrayOrNull(
       uint32_t length,
       InitializationPolicy allocation_policy =
diff --git a/third_party/blink/renderer/modules/webaudio/realtime_analyser.cc b/third_party/blink/renderer/modules/webaudio/realtime_analyser.cc
index dc68f422ce8af..9c1f852d649b7 100644
--- a/third_party/blink/renderer/modules/webaudio/realtime_analyser.cc
+++ b/third_party/blink/renderer/modules/webaudio/realtime_analyser.cc
@@ -37,6 +37,9 @@
 #include "third_party/blink/renderer/platform/audio/audio_utilities.h"
 #include "third_party/blink/renderer/platform/audio/vector_math.h"
 #include "third_party/blink/renderer/platform/wtf/math_extras.h"
+#include <random>
+#include "base/command_line.h"
+#include "third_party/blink/public/common/switches.h"
 
 namespace blink {
 
@@ -70,6 +73,23 @@ float EnsureFinite(float x, float default_value) {
 
 }  // namespace
 
+namespace {
+
+uint64_t GetAudioNoiseSeed() {
+  auto* cmd = base::CommandLine::ForCurrentProcess();
+  if (!cmd->HasSwitch(blink::switches::kAspectAudioNoiseSeed)) {
+    return 0;
+  }
+  uint64_t seed = 0;
+  auto s = cmd->GetSwitchValueASCII(blink::switches::kAspectAudioNoiseSeed);
+  for (char c : s) {
+    seed = seed * 31 + static_cast<uint64_t>(c);
+  }
+  return seed;
+}
+
+}  // namespace
+
 RealtimeAnalyser::RealtimeAnalyser(unsigned render_quantum_frames)
     : input_buffer_(kInputBufferSize),
       down_mix_bus_(AudioBus::Create(1, render_quantum_frames)),
@@ -120,6 +140,16 @@ void RealtimeAnalyser::GetFloatFrequencyData(DOMFloat32Array* destination_array,
       const double db_mag = audio_utilities::LinearToDecibels(linear_value);
       UNSAFE_TODO(destination[i]) = static_cast<float>(db_mag);
     }
+
+    uint64_t audio_seed = GetAudioNoiseSeed();
+    if (audio_seed != 0) {
+      std::mt19937_64 rng(audio_seed ^ (static_cast<uint64_t>(len) * 2654435761u));
+      for (unsigned j = 0; j < len; ++j) {
+        float noise = static_cast<float>(
+            static_cast<int64_t>(rng() % 2001) - 1000) * 1e-7f;
+        UNSAFE_TODO(destination[j]) += noise;
+      }
+    }
   }
 }
 
@@ -163,6 +193,17 @@ void RealtimeAnalyser::GetByteFrequencyData(DOMUint8Array* destination_array,
       UNSAFE_TODO(destination[i]) =
           static_cast<unsigned char>(ClampTo(scaled_value, 0, UCHAR_MAX));
     }
+
+    uint64_t audio_seed = GetAudioNoiseSeed();
+    if (audio_seed != 0) {
+      std::mt19937_64 rng(audio_seed ^ (static_cast<uint64_t>(len) * 40503u));
+      for (unsigned j = 0; j < len; ++j) {
+        int val = static_cast<int>(UNSAFE_TODO(destination[j]));
+        val += static_cast<int>(rng() % 3) - 1;
+        UNSAFE_TODO(destination[j]) =
+            static_cast<unsigned char>(ClampTo(val, 0, UCHAR_MAX));
+      }
+    }
   }
 }
 
@@ -191,6 +232,16 @@ void RealtimeAnalyser::GetFloatTimeDomainData(
 
       UNSAFE_TODO(destination[i]) = value;
     }
+
+    uint64_t audio_seed = GetAudioNoiseSeed();
+    if (audio_seed != 0) {
+      std::mt19937_64 rng(audio_seed ^ (static_cast<uint64_t>(len) * 2246822519u));
+      for (unsigned j = 0; j < len; ++j) {
+        float noise = static_cast<float>(
+            static_cast<int64_t>(rng() % 2001) - 1000) * 1e-7f;
+        UNSAFE_TODO(destination[j]) += noise;
+      }
+    }
   }
 }
 
@@ -223,6 +274,17 @@ void RealtimeAnalyser::GetByteTimeDomainData(DOMUint8Array* destination_array) {
       UNSAFE_TODO(destination[i]) =
           static_cast<unsigned char>(ClampTo(scaled_value, 0, UCHAR_MAX));
     }
+
+    uint64_t audio_seed = GetAudioNoiseSeed();
+    if (audio_seed != 0) {
+      std::mt19937_64 rng(audio_seed ^ (static_cast<uint64_t>(len) * 3266489917u));
+      for (unsigned j = 0; j < len; ++j) {
+        int val = static_cast<int>(UNSAFE_TODO(destination[j]));
+        val += static_cast<int>(rng() % 3) - 1;
+        UNSAFE_TODO(destination[j]) =
+            static_cast<unsigned char>(ClampTo(val, 0, UCHAR_MAX));
+      }
+    }
   }
 }
 
-- 
2.39.5

